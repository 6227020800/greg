{"version":3,"sources":["assets/js/eximport.js"],"names":["eximport","export_ical","filename","event_data","navigator","getDeviceStorage","sdcard","request_del","delete","onsuccess","setTimeout","data","result","forEach","e","index","key","Object","keys","length","file","Blob","type","request","addNamed","helper","side_toaster","onerror","toaster","list_ics","file_list","cb","push","fn","split","document","querySelector","insertAdjacentHTML","list_files","parse_ics","callback","saveOnDevice","subscription","join","jcalData","ICAL","parse","vcalendar","Component","last_uid","last_date","isoDateTimeEnd","getAllSubcomponents","getFirstPropertyValue","DTend","dateEnd","timeEnd","design","icalendar","value","toICAL","Date","getFullYear","getMonth","slice","getDate","getHours","getMinutes","getSeconds","replace","DTstart","dateStart","timeStart","isoDateTimeStart","multidayevent","getTime","g","parse_rrule","feedback","a","toString","parse_rrule2","freq","imp","BEGIN","UID","SUMMARY","LOCATION","DESCRIPTION","ATTACH","RRULE","CLASS","DTSTAMP","DTSTART","DTEND","END","time_start","time_end","notification","alarm","isSubscription","rrule_","date","events","without_subscription","filter","localforage","setItem","then","catch","err","console","log","fetch_ics","url","xhttp","XMLHttpRequest","mozSystem","open","timeout","onload","readyState","DONE","status","response","send","share","name","activity","MozActivity","number","blobs","filenames","loadICS","get","reader","FileReader","event","abort","onloadend","target","readAsText","warn","error"],"mappings":"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","file":"eximport.c7695363.js","sourceRoot":"../application","sourcesContent":["const eximport = (() => {\n  let export_ical = function (filename, event_data) {\n    if (!navigator.getDeviceStorage) return false;\n\n    var sdcard = navigator.getDeviceStorage(\"sdcard\");\n\n    var request_del = sdcard.delete(filename);\n    request_del.onsuccess = function () {};\n    setTimeout(function () {\n      // convert\n      let data = event_data;\n      let result = \"\";\n\n      result += \"BEGIN:VCALENDAR\" + \"\\r\\n\";\n      result += \"VERSION:2.0\" + \"\\r\\n\";\n      result += \"PRODID:GREG\" + \"\\r\\n\";\n      result += \"METHOD:PUBLISHED\" + \"\\r\\n\";\n\n      data.forEach((e) => {\n        let index = -1;\n        for (let key in e) {\n          index++;\n          if (index == 0) result += \"BEGIN:VEVENT\" + \"\\r\\n\";\n\n          if (\n            key != \"BEGIN\" &&\n            key != \"END\" &&\n            key != \"date\" &&\n            key != \"time_start\" &&\n            key != \"time_end\" &&\n            key != \"dateStart\" &&\n            key != \"dateEnd\" &&\n            key != \"notification\" &&\n            key != \"alarm\" &&\n            key != \"isSubscription\" &&\n            key != \"multidayevent\" &&\n            key != \"alarmTrigger\" &&\n            key != \"rrule_\"\n          ) {\n            result += `${key}:${e[key]}` + \"\\r\\n\";\n          }\n          if (index == Object.keys(e).length - 1)\n            result += \"END:VEVENT\" + \"\\r\\n\";\n        }\n      });\n\n      result += \"END:VCALENDAR\" + \"\\r\\n\";\n      var file = new Blob([result], { type: \"text/calendar\" });\n      var request = sdcard.addNamed(file, filename);\n      request.onsuccess = function () {\n        helper.side_toaster(\"<img src='assets/image/E25C.svg'>\", 2500);\n      };\n\n      request.onerror = function () {\n        helper.toaster(\"Unable to write the file\", 2000);\n      };\n    }, 2000);\n  };\n\n  // //////////\n\n  // /LIST ICS\n\n  // ////////////\n\n  let list_ics = function () {\n    let file_list = [];\n    let cb = function (result) {\n      file_list.push(result);\n\n      let fn = result.split(\"/\");\n      fn = fn[fn.length - 1];\n      if (fn == \"greg.ics\") return false;\n\n      document\n        .querySelector(\"div#options div#import-text\")\n        .insertAdjacentHTML(\n          \"afterend\",\n          '<button class=\"item dynamic\" data-function=\"import\" data-filename=\"' +\n            result +\n            '\">' +\n            fn +\n            \"</button>\"\n        );\n    };\n\n    helper.list_files(\"ics\", cb);\n  };\n\n  // /////////////\n  // /PARSE ICS\n  // /////////////\n\n  let parse_ics = function (data, callback, saveOnDevice, subscription) {\n    var data = data.split(/\\r\\n|\\n/);\n    data = data.join(\"\\r\\n\");\n    // parse iCal data\n    var jcalData = ICAL.parse(data);\n    var vcalendar = new ICAL.Component(jcalData);\n    let last_uid = \"\";\n    let last_date = \"\";\n    let isoDateTimeEnd = \"\";\n\n\n\n    vcalendar.getAllSubcomponents(\"vevent\").forEach(function (index) {\n      if (\n        index.getFirstPropertyValue(\"dtstart\") == \"\" &&\n        index.getFirstPropertyValue(\"summary\") == \"\"\n      )\n        return false;\n\n      let DTend = null;\n      let dateEnd = null;\n      let timeEnd = null;\n      if (index.getFirstPropertyValue(\"dtend\") != null) {\n        DTend = ICAL.design.icalendar.value[\"date-time\"].toICAL(\n          index.getFirstPropertyValue(\"dtend\")\n        );\n\n        DTend = new Date(index.getFirstPropertyValue(\"dtend\"));\n\n\n\n\n\n        dateEnd =\n          DTend.getFullYear() +\n          \"-\" +\n          `0${DTend.getMonth() + 1}`.slice(-2) +\n          \"-\" +\n          `0${DTend.getDate()}`.slice(-2);\n\n        timeEnd =\n          `0${DTend.getHours()}`.slice(-2) +\n          \":\" +\n          `0${DTend.getMinutes()}`.slice(-2) +\n          \":\" +\n          `0${DTend.getSeconds()}`.slice(-2);\n\n        isoDateTimeEnd = dateEnd + \"T\" + timeEnd;\n        isoDateTimeEnd = isoDateTimeEnd.replace(/-/g, \"\");\n        isoDateTimeEnd = isoDateTimeEnd.replace(/:/g, \"\");\n      }\n\n      let DTstart = null;\n      let dateStart = null;\n      let timeStart = null;\n      let isoDateTimeStart = null;\n      if (index.getFirstPropertyValue(\"dtstart\") != null) {\n        DTstart = ICAL.design.icalendar.value[\"date-time\"].toICAL(\n          index.getFirstPropertyValue(\"dtstart\")\n        );\n\n        DTstart = new Date(index.getFirstPropertyValue(\"dtstart\"));\n\n        dateStart =\n          DTstart.getFullYear() +\n          \"-\" +\n          `0${DTstart.getMonth() + 1}`.slice(-2) +\n          \"-\" +\n          `0${DTstart.getDate()}`.slice(-2);\n\n        timeStart =\n          `0${DTstart.getHours()}`.slice(-2) +\n          \":\" +\n          `0${DTstart.getMinutes()}`.slice(-2) +\n          \":\" +\n          `0${DTstart.getSeconds()}`.slice(-2);\n\n        isoDateTimeStart = dateStart + \"T\" + timeStart;\n        isoDateTimeStart = isoDateTimeStart.replace(/-/g, \"\");\n        isoDateTimeStart = isoDateTimeStart.replace(/:/g, \"\");\n      }\n\n      // check multi day events\n      multidayevent = false;\n      if (new Date(dateEnd).getTime() > new Date(dateStart).getTime()) {\n        multidayevent = true;\n      }\n\n      // last modified\n      let g = new Date(index.getFirstPropertyValue(\"last-modified\")).getTime();\n\n      if (timeStart == timeEnd) {\n        timeStart = \"\";\n        timeEnd = \"\";\n      }\n\n\n\n\n      last_uid = \"\";\n      last_date = \"\";\n      let parse_rrule = function () {\n        let feedback = \"\";\n        if (index.getFirstPropertyValue(\"rrule\") != null) {\n          let a = index.getFirstPropertyValue(\"rrule\");\n          feedback = a.toString();\n        }\n\n        return feedback;\n      };\n\n      let parse_rrule2 = function () {\n        let feedback = \"none\";\n        if (index.getFirstPropertyValue(\"rrule\") != null) {\n          let a = index.getFirstPropertyValue(\"rrule\");\n          feedback = a.freq;\n        }\n\n        return feedback;\n      };\n\n\n\n\n      let imp = {\n        BEGIN: \"VEVENT\",\n        UID: index.getFirstPropertyValue(\"uid\"),\n        SUMMARY: index.getFirstPropertyValue(\"summary\"),\n        LOCATION: index.getFirstPropertyValue(\"location\"),\n        DESCRIPTION: index.getFirstPropertyValue(\"description\"),\n        ATTACH: index.getFirstPropertyValue(\"attach\"),\n        RRULE: parse_rrule(),\n        \"LAST-MODIFIED\": g,\n        CLASS: \"PRIVATE\",\n        DTSTAMP: isoDateTimeStart,\n        DTSTART: isoDateTimeStart,\n        DTEND: isoDateTimeEnd,\n        END: \"VEVENT\",\n        dateStart: dateStart,\n        dateEnd: dateEnd,\n        time_start: timeStart,\n        time_end: timeEnd,\n        notification: \" \",\n        alarm: \"none\",\n        isSubscription: subscription,\n        multidayevent: multidayevent,\n        rrule_: parse_rrule2(),\n      };\n\n\n      last_uid = imp.UID;\n      last_date = imp.date;\n      events.push(imp);\n\n    });\n\n\n\n\n    if (saveOnDevice) {\n      let without_subscription = events.filter(\n        (events) => events.isSubscription === false\n      );\n      \n\n      localforage\n        .setItem(\"events\", without_subscription)\n        .then(function (value) {\n          // events = value;\n          helper.side_toaster(\"<img src='assets/image/E25C.svg'>\", 2500);\n        })\n        .catch(function (err) {\n          console.log(err);\n        });\n    }\n    \n\n        \n\n    callback(last_uid, last_date);\n\nconsole.log(\"done\")\n  };\n\n  // ///////////\n  // /FETCH ICS\n  // /////////\n\n  let fetch_ics = function (url, cb) {\n    let xhttp = new XMLHttpRequest({ mozSystem: true });\n\n    xhttp.open(\"GET\", url + \"?time=\" + new Date().getTime(), true);\n    xhttp.timeout = 25000;\n    xhttp.onload = function () {\n      if (xhttp.readyState === xhttp.DONE && xhttp.status === 200) {\n        let data = xhttp.response;\n        parse_ics(data, cb, false, true);\n      }\n    };\n\n    xhttp.onerror = function () {\n      helper.toaster(\"subscription could not be loaded\", 2000);\n    };\n\n    xhttp.send(null);\n  };\n\n  function share(url, name) {\n    var activity = new MozActivity({\n      name: \"share\",\n      data: {\n        type: \"text/calendar\",\n        number: 1,\n        blobs: [url],\n        filenames: [name],\n      },\n    });\n\n    activity.onsuccess = function () {};\n\n    activity.onerror = function () {};\n  }\n\n  // ///////////////////////\n  // ///Load ICS///////////\n  // /////////////////////\n\n  function loadICS(filename, callback) {\n    var sdcard = navigator.getDeviceStorage(\"sdcard\");\n\n    var request = sdcard.get(filename);\n\n    request.onsuccess = function () {\n      var file = this.result;\n\n      let reader = new FileReader();\n\n      reader.onerror = function (event) {\n        helper.toaster(\"can't read file\", 3000);\n        reader.abort();\n      };\n\n      reader.onloadend = function (event) {\n        parse_ics(event.target.result, callback, true, false);\n      };\n\n      reader.readAsText(file);\n    };\n\n    request.onerror = function () {\n      console.warn(\"Unable to get the file: \" + this.error);\n    };\n\n \n  }\n\n  return {\n    export_ical,\n    list_ics,\n    loadICS,\n    share,\n    fetch_ics,\n  };\n})();\n"]}